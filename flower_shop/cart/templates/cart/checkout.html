{% extends "base.html" %}
{% load cart_tags %}

{% block content %}
<div class="container">
    <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à –∑–∞–∫–∞–∑ –ø–µ—Ä–µ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.</p>

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–æ—Ä–∑–∏–Ω—ã -->
    {% if flowers %}
        <ul class="list-group">
            {% for item in flowers %}
                <li class="list-group-item">
                    <img src="{{ item.flower.image.url }}" alt="{{ item.flower.name }}" class="flower-preview" style="max-width: 150px; height: auto;">
                    <strong>{{ item.flower.name }}</strong>
                    <br>üí∞ –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É: {{ item.flower.price }} ‚ÇΩ
                    <br>üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ item.quantity }}
                    <br>üí∏ –ò—Ç–æ–≥–æ: {{ item.subtotal }} ‚ÇΩ
                </li>
            {% endfor %}
        </ul>
        <h3>üíµ –û–±—â–∞—è —Å—É–º–º–∞: {{ total_price }} ‚ÇΩ</h3>
    {% else %}
        <p>üòï –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
    {% endif %}

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
    <form id="checkout-form" method="post" class="mt-3">
        {% csrf_token %}
        <div class="form-group">
            <label for="address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
            <input type="text" 
                   class="form-control" 
                   id="address" 
                   name="address" 
                   value="{{ profile.address }}"
                   required>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
        <button type="submit" class="btn btn-primary mt-3">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </form>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É -->
    <a href="{% url 'view_cart' %}" class="btn btn-secondary mt-2">üõí –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω—É</a>

    <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö -->
    <div id="error-message" class="alert alert-danger mt-3" style="display: none; white-space: pre-line;"></div>

    <script>
    document.getElementById("checkout-form").addEventListener("submit", function(event) {
        event.preventDefault();
        const errorMessageDiv = document.getElementById("error-message");
        errorMessageDiv.style.display = "none";  // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

        fetch('/cart/checkout/', {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams(new FormData(this)).toString()
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;  // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
            } else {
                errorMessageDiv.textContent = data.message;
                errorMessageDiv.style.display = "block";  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            }
        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:", error);
            errorMessageDiv.textContent = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.";
            errorMessageDiv.style.display = "block";
        });
    });
    </script>
</div>
{% endblock %}