{% extends "base.html" %}
{% load cart_tags %}

{% block content %}
<h2>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>

{% if flowers %}
    <ul class="list-group">
        {% for item in flowers %}
            <li class="list-group-item" id="cart-item-{{ item.flower.id }}">
                <img src="{{ item.flower.image.url }}" alt="{{ item.flower.name }}" class="flower-preview" style="max-width: 150px; height: auto;">
                <strong>{{ item.flower.name }}</strong>
                <br>üí∞ <span id="subtotal-{{ item.flower.id }}">{{ item.subtotal }}</span> ‚ÇΩ
                <br>
                <button onclick="updateCart({{ item.flower.id }}, -1)">‚ûñ</button>
                <span id="cart-qty-{{ item.flower.id }}">{{ item.quantity }}</span>
                <button onclick="updateCart({{ item.flower.id }}, 1)">‚ûï</button>
                <button onclick="removeFromCart({{ item.flower.id }})" class="btn btn-danger btn-sm">üóë –£–±—Ä–∞—Ç—å</button>
            </li>
        {% endfor %}
    </ul>
    <h3>üíµ –ò—Ç–æ–≥: <span id="total-price">{{ total_price }}</span> ‚ÇΩ</h3>
    
    <!-- –ö–Ω–æ–ø–∫–∞ "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑" –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <a href="{% url 'checkout' %}" class="btn btn-success">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
    
    <button onclick="clearCart()" class="btn btn-warning">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
{% else %}
    <p>üòï –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
{% endif %}

<script>
function updateCart(flowerId, change) {
    let qtySpan = document.getElementById(`cart-qty-${flowerId}`);
    let subtotalSpan = document.getElementById(`subtotal-${flowerId}`);
    let totalPriceSpan = document.getElementById("total-price");
    let cartItem = document.getElementById(`cart-item-${flowerId}`);

    let newQty = parseInt(qtySpan.textContent) + change;

    fetch(`/cart/update/${flowerId}/${newQty}/`, { 
        method: "POST", 
        headers: {"X-CSRFToken": "{{ csrf_token }}"}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (newQty > 0) {
                qtySpan.textContent = newQty;
                subtotalSpan.textContent = data.subtotal;
                totalPriceSpan.textContent = data.total_price;
            } else {
                if (cartItem) {
                    cartItem.remove();  // ‚úÖ –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                }
                totalPriceSpan.textContent = data.total_price;

                // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                if (data.total_price === 0) {
                    location.reload();
                }
            }
        }
    })
    .catch(error => console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã:", error));
}

function removeFromCart(flowerId) {
    fetch(`/cart/remove/${flowerId}/`, { 
        method: "POST", 
        headers: {"X-CSRFToken": "{{ csrf_token }}"}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
        }
    });
}

function clearCart() {
    fetch(`/cart/clear/`, { 
        method: "POST", 
        headers: {"X-CSRFToken": "{{ csrf_token }}"}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
        }
    });
}
</script>

{% endblock %}