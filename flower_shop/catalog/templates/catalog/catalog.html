{% extends "base.html" %}
{% load cart_tags %}

{% block content %}
<h2>üå∏ –ö–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤</h2>

<style>
.flower-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ */
    gap: 20px; /* –û—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
    justify-content: center;
}

.flower-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    background: #fff;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
}

.flower-preview {
    max-width: 150px;
    height: auto;
    border-radius: 5px;
}
</style>

<div class="flower-grid">
    {% for flower in flowers %}
        <div class="flower-card">
            <img src="{{ flower.image.url }}" alt="{{ flower.name }}" class="flower-preview">
            <h3>{{ flower.name }}</h3>
            <p>–¶–µ–Ω–∞: {{ flower.price }} ‚ÇΩ</p>

            <div id="cart-controls-{{ flower.id }}">
                {% if request.session.cart|get_item:flower.id %}
                    <div class="cart-controls">
                        <button onclick="updateCart({{ flower.id }}, -1)">‚ûñ</button>
                        <span id="cart-qty-{{ flower.id }}">{{ request.session.cart|get_item:flower.id }}</span>
                        <button onclick="updateCart({{ flower.id }}, 1)">‚ûï</button>
                    </div>
                {% else %}
                    <button onclick="addToCart({{ flower.id }})" class="btn btn-primary">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button>
                {% endif %}
            </div>
        </div>
    {% endfor %}
</div>

<a href="{% url 'view_cart' %}" class="btn btn-success">üõí –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É</a>

<script>
function addToCart(flowerId) {
    fetch(`/cart/add/${flowerId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken(),
            "Content-Type": "application/json"
        }
    })
    .then(response => response.json())
.then(data => {
    console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data); // –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (data.success) {
        console.log("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ DOM –¥–ª—è flowerId:", flowerId); // –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        let cartControls = document.getElementById(`cart-controls-${flowerId}`);
        cartControls.innerHTML = `
            <div class="cart-controls">
                        <button onclick="window.location.href='/cart/'" class="btn btn-success">üõí –í –∫–æ—Ä–∑–∏–Ω–µ</button>
                <button onclick="updateCart(${flowerId}, -1)">‚ûñ</button>
                <span id="cart-qty-${flowerId}">${data.quantity}</span>
                <button onclick="updateCart(${flowerId}, 1)">‚ûï</button>
            </div>
        `;
    }
})
    .catch(error => console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É:", error));
}

function updateCart(flowerId, change) {
    let qtySpan = document.getElementById(`cart-qty-${flowerId}`);
    let newQty = parseInt(qtySpan.textContent) + change;

    fetch(`/cart/update/${flowerId}/${newQty}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken(),
            "Content-Type": "application/json"
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (newQty > 0) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫—É "–í –∫–æ—Ä–∑–∏–Ω—É"
                qtySpan.textContent = newQty;
                let cartControls = document.getElementById(`cart-controls-${flowerId}`);
                cartControls.innerHTML = `
                    <div class="cart-controls">
                        <button onclick="window.location.href='/cart/'" class="btn btn-success">üõí –í –∫–æ—Ä–∑–∏–Ω–µ</button>
                        <button onclick="updateCart(${flowerId}, -1)">‚ûñ</button>
                        <span id="cart-qty-${flowerId}">${newQty}</span>
                        <button onclick="updateCart(${flowerId}, 1)">‚ûï</button>
                    </div>
                `;
            } else {
                // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∏–≥–ª–æ –Ω—É–ª—è, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É "–í –∫–æ—Ä–∑–∏–Ω—É"
                document.getElementById(`cart-controls-${flowerId}`).innerHTML = `
                    <button onclick="addToCart(${flowerId})" class="btn btn-primary">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button>
                `;
            }
        }
    })
    .catch(error => console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã:", error));
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞
function getCSRFToken() {
    let csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfTokenElement ? csrfTokenElement.value : getCookie("csrftoken");
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É–∫–∏
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        let cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}
